/*! L.Mappy 5.4.1 2016-11-16 */
!function(L){"use strict";var random_string=function(length){var str;for(str="";str.length<length;)str+=Math.random().toString(36)[2];return str},object_to_uri=function(obj){var data,key,value;data=[];for(key in obj)value=obj[key],data.push(window.encodeURIComponent(key)+"="+window.encodeURIComponent(value));return data.join("&")},translations={fr:{"layers.traffic":"Trafic","layers.transport":"Transports en commun","layers.photo":"Vue aérienne","layers.hybrid":"Afficher le nom des lieux","trafficLegend.trafficAt":"Trafic à {hours}:{minutes}","trafficLegend.slow":"ralenti","trafficLegend.blocked":"fermé","vehicle.comcar":"Petite voiture","vehicle.midcar":"Voiture de taille moyenne","vehicle.sedcar":"Routière","vehicle.luxcar":"Grande routière","vehicle.caravancar":"Véhicule avec caravane","vehicle.2-lt3.5":"Poids lourd, PTAC < 3.5T (2 essieux)","vehicle.2-lt12":"Poids lourd, PTAC < 12T (2 essieux)","vehicle.2-gt12":"Poids lourd, PTAC > 12T (2 essieux)","vehicle.2-gt12a":"Poids lourd, PTAC > 12T, articulé (2 essieux)","vehicle.3-lt3.5":"Poids lourd, PTAC < 3.5T (3 essieux ou plus)","vehicle.3-lt12":"Poids lourd, PTAC < 12T (3 essieux ou plus)","vehicle.3-gt12":"Poids lourd, PTAC > 12T (3 essieux ou plus)","vehicle.3-gt12a":"Poids lourd, PTAC > 12T, articulé (3 essieux ou plus)","vehicle.mot":"Moto","vehicle.van":"Camping car","vehicle.2-coa":"Bus 2 essieux","vehicle.3-coa":"Bus 3 essieux","vehicle.ped":"Piéton","vehicle.bik":"Vélo","vehicle.bike":"Vélo en libre-service","vehicle.pub_tp":"Transports en commun","bikelegend.title":"Pistes cyclables"},en:{"layers.traffic":"Traffic","layers.transport":"Public transports","layers.photo":"Satellite photos","layers.hybrid":"Display locations names","trafficLegend.trafficAt":"Traffic at {hours}:{minutes}","trafficLegend.slow":"slow","trafficLegend.blocked":"congested","vehicle.comcar":"Compact car","vehicle.midcar":"Medium-size car","vehicle.sedcar":"Sedan car","vehicle.luxcar":"Luxury car","vehicle.caravancar":"Vehicle with caravan","vehicle.2-lt3.5":"Truck, GVWR < 3.5T (2 axles)","vehicle.2-lt12":"Truck, GVWR < 12T (2 axles)","vehicle.2-gt12":"Truck, GVWR > 12T (2 axles)","vehicle.2-gt12a":"Truck, GVWR > 12T, articulated (2 axles)","vehicle.3-lt3.5":"Truck, GVWR < 3.5T (3 axles or more)","vehicle.3-lt12":"Truck, GVWR < 12T (3 axles or more)","vehicle.3-gt12":"Truck, GVWR > 12T (3 axles or more)","vehicle.3-gt12a":"Truck, GVWR > 12T, articulated (3 axles or more)","vehicle.mot":"Motorbike","vehicle.van":"Campervan","vehicle.2-coa":"Bus 2 axles","vehicle.3-coa":"Bus 3 axles","vehicle.ped":"Pedestrian","vehicle.bik":"Bicycle","bikelegend.title":"Bicycle paths"},nl:{"layers.traffic":"Verkeer","layers.transport":"Openbaar vervoer","layers.photo":"Luchtfoto's","layers.hybrid":"Locaties weergeven namen","trafficLegend.trafficAt":"Verkeer op {hours}:{minutes}","trafficLegend.slow":"langzaam","trafficLegend.blocked":"vastgelopen","vehicle.comcar":"Kleine auto","vehicle.midcar":"Middelgrote auto","vehicle.sedcar":"Grote auto","vehicle.luxcar":"Luxeauto","vehicle.caravancar":"Voertuig met caravan","vehicle.2-lt3.5":"Vrachtwagen, MTM < 3,5 T (2 assen)","vehicle.2-lt12":"Vrachtwagen, MTM < 12 T (2 assen)","vehicle.2-gt12":"Vrachtwagen, MTM > 12 T (2 assen)","vehicle.2-gt12a":"Vrachtwagen, MTM > 12 T, met oplegger (2 assen)","vehicle.3-lt3.5":"Vrachtwagen, MTM < 3,5 T (3 of meer assen)","vehicle.3-lt12":"Vrachtwagen, MTM < 12 T (3 of meer assen)","vehicle.3-gt12":"Vrachtwagen, MTM > 12 T (3 of meer assen)","vehicle.3-gt12a":"Vrachtwagen, MTM > 12 T, met oplegger (3 of meer assen)","vehicle.mot":"Motor","vehicle.van":"Camping car","vehicle.2-coa":"Bus 2 assen","vehicle.3-coa":"Bus 3 assen","vehicle.ped":"Voetganger","vehicle.bik":"Fiets","bikelegend.title":"Fietspaden"}};L.Mappy={version:"5.4.1",_domain:"mappy.net",_token:"g0ztPgTHGBpIzhtEqb8IVksxgvRO/VCtTwFgtyNXgrE1AkVLgdBHwFgwpQ55cR5jtxZX0O5W1nY=",_clientId:null,_https:"https"===document.location.protocol.substr(0,5),_locale:"fr_FR",_imgPath:"images/",getText:function(key){return translations[this._locale.substr(0,2)][key]||""},setLocale:function(locale){if("fr_FR"!==locale&&"en_GB"!==locale&&"fr_BE"!==locale&&"nl_BE"!==locale)throw new Error("This locale is not available");this._locale=locale},setImgPath:function(path){this._imgPath=path},getImgPath:function(){return this._imgPath},getLocale:function(){return this._locale},setToken:function(){throw new Error("setToken is deprecated in favor of setClientId (refer to documentation)")},_getToken:function(){return this._token},setClientId:function(clientId){if(this._clientId=clientId,this._clientId){var pingUrl="http"+(L.Mappy._getHttps()?"s":"")+"://log."+L.Mappy._getDomain()+"/log/1.0/ping/api-leaflet/"+this._clientId+"/"+L.Mappy.version;setTimeout(function(){(new Image).src=pingUrl},1e3)}},_getClientId:function(){return this._clientId},enableHttps:function(){this._https=!0},disableHttps:function(){this._https=!1},_getHttps:function(){return this._https},_getDomain:function(){return this._domain},_checkClientId:function(){if(!this._getClientId())throw new Error("ClientId is mandatory (refer to documentation).")},JSONP:function(options){var callback,done,head,params,script;if(options=options?options:{},params={data:options.data||{},error:options.error||L.Util.falseFn,success:options.success||L.Util.falseFn,url:options.url||""},0===params.url.length)throw new Error("MissingUrl");return done=!1,callback=params.data[options.callback_name||"callback"]="jsonp_"+random_string(15),window[callback]=function(data){params.success(data),window[callback]=null},script=window.document.createElement("script"),script.src=params.url,script.src+=params.url.indexOf(!1)?"?":"&",script.src+=object_to_uri(params.data),script.async=!0,script.onerror=function(){return params.error("server_error")},script.onload=script.onreadystatechange=function(){return done||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(done=!0,script.onload=script.onreadystatechange=null,!script||!script.parentNode)?void 0:script.parentNode.removeChild(script)},head=head||window.document.getElementsByTagName("head")[0],head.appendChild(script)},cors:function(options){var req;window.XDomainRequest?(req=new XDomainRequest,options.data?req.open("GET",options.url+"?"+object_to_uri(options.data)):req.open("GET",options.url),options.error&&(req.onerror=options.error),req.onload=function(){options.success(JSON.parse(req.responseText))},req.send()):window.XMLHttpRequest?(req=new XMLHttpRequest,options.data?req.open("GET",options.url+"?"+object_to_uri(options.data),!0):req.open("GET",options.url,!0),req.onerror=function(){options.error&&options.error("server_error")},req.onreadystatechange=function(){4===req.readyState&&(req.status>=200&&req.status<400?options.success(JSON.parse(req.responseText)):req.status>=400&&req.status<500&&options.error("no_result"))},req.send()):options.error("cors_not_supported")}},L.Util.debounce=function(func,timeout){var timeoutID;return timeout=timeout||300,function(){var scope=this,args=arguments;clearTimeout(timeoutID),timeoutID=setTimeout(function(){func.apply(scope,Array.prototype.slice.call(args))},timeout)}};var Attribution=L.Control.Attribution.extend({options:{scale:!0,position:"bottomleft",prefix:'&copy; <a href="http://corporate.mappy.com/conditions-dutilisation/copyright/" title="Mappy" target="_blank">Mappy</a> '},_layers:[],onAdd:function(map){map.on("layeradd",function(evt){evt.layer instanceof L.Mappy.TileLayer&&(this._layers.push(evt.layer),evt.layer.on("attributionsrefresh",this._refreshAttributions,this))},this),map.on("layerremove",function(evt){for(var i=this._layers.length-1;i>=0;i--)this._layers[i]===evt.layer&&(this._layers.splice(i,1),evt.layer.off("attributionsrefresh",this._refreshAttributions,this),this._refreshAttributions())},this);var container=L.Control.Attribution.prototype.onAdd.call(this,map);return this.options.scale&&L.control.scale({imperial:!1,position:this.options.position}).addTo(map),container},addTo:function(map){this._map=map;var container=this._container=this.onAdd(map),pos=this.getPosition(),corner=map._controlCorners[pos];return L.DomUtil.addClass(container,"leaflet-control"),corner.appendChild(container),this},removeFrom:L.Util.falseFn,remove:L.Util.falseFn,clearAttributions:function(){this._attributions={},this._update()},_refreshAttributions:function(){this.clearAttributions();for(var attribs=[],i=this._layers.length-1;i>=0;i--)attribs=attribs.concat(this._layers[i].getAttributions());for(var j=0;j<attribs.length;j++)this.addAttribution(attribs[j])}});L.Mappy.Control=L.Control.extend({options:{position:"topright",singleToolBox:!1},statics:{mainContainer:null},_buttons:{},_tooltips:{},addTo:function(map){return this._buttons={},this._tooltips={},L.Control.prototype.addTo.call(this,map),L.DomUtil.addClass(this._container,"mappy-control"),this},removeFrom:function(map){var pos=this.getPosition(),corner=map._controlCorners[pos];return(!this.options.singleToolBox||this.options.singleToolBox&&L.Mappy.Control.mainContainer)&&(corner.removeChild(this._container),this._container=null),this.options.singleToolBox&&L.Mappy.Control.mainContainer&&(L.Mappy.Control.mainContainer=null),this._map=null,this.onRemove&&this.onRemove(map),this},_createContainer:function(className){return this._container=L.DomUtil.create("div","mappy-control-"+className),this._container},_getContainer:function(name){return this.options.singleToolBox?(L.Mappy.Control.mainContainer||(L.Mappy.Control.mainContainer=L.DomUtil.create("div","mappy-control-main")),L.Mappy.Control.mainContainer):L.DomUtil.create("div","mappy-control-"+name)},_createBasicButton:function(html,className){var btn=L.DomUtil.create("a","mappy-button mappy-button-"+className,this._container);return btn.innerHTML=html||"",btn.href="#",L.DomEvent.on(btn,"mousedown",L.DomEvent.stop).on(btn,"dblclick",L.DomEvent.stop).on(btn,"click",L.DomEvent.stop),btn},_createButton:function(html,title,className,fn){var btn=this._createBasicButton(html,className);return this._initTooltip(title,className,btn),L.DomEvent.on(btn,"click",fn,this).on(btn,"click",this._refocusOnMap,this),btn},_createSwitch:function(html,title,title2,className,fn,fn2,delay){var btn=this._createBasicButton(html,className);return this._initTooltip(title,className,btn,delay),L.DomEvent.on(btn,"click",function(evt){L.DomUtil.hasClass(btn,"mappy-button-active")?(this.deactivateButton(btn),this._updateTooltipContent(title,className),fn2.call(this,evt)):(this.activateButton(btn),this._updateTooltipContent(title2,className),fn.call(this,evt)),this._refocusOnMap()},this),btn},_initTooltip:function(title,className,btn,delay){title&&(L.Browser.touch?L.DomEvent.on(btn,"click",function(){this._closeTooltips(),this._createTooltip(title,className,btn),L.Mappy.layerTooltip&&clearInterval(L.Mappy.layerTooltip),L.Mappy.layerTooltip=setTimeout(L.bind(function(){this._closeTooltip(className)},this),2e3)},this):L.DomEvent.on(btn,"mouseenter",function(){this._closeTooltips(),this._createTooltip(title,className,btn)},this).on(btn,"mouseleave",function(){this._closeTooltip(className,delay)},this))},_createTooltip:function(title,id,btn){if(this._tooltips[id])this._container.appendChild(this._tooltips[id]);else{var tooltip=L.DomUtil.create("div","mappy-tooltip",this._container);"string"==typeof title?tooltip.innerHTML=title:tooltip.appendChild(title),this._tooltips[id]=tooltip}this._tooltips[id].style.top=btn.offsetTop+(btn.offsetHeight-this._tooltips[id].offsetHeight)/2+"px"},_updateTooltipContent:function(title,id){this._tooltips[id]&&title&&("string"==typeof title?this._tooltips[id].innerHTML=title:this._tooltips[id].appendChild(title))},_closeTooltip:function(id,delay){this._removing=setTimeout(L.bind(function(){this._tooltips[id].parentNode&&this._container.removeChild(this._tooltips[id])},this),delay||0)},_closeTooltips:function(){clearTimeout(this._removing);for(var tooltip in this._tooltips)this._tooltips[tooltip].parentNode&&this._tooltips[tooltip].parentNode.removeChild(this._tooltips[tooltip])},activateButton:function(button){L.DomUtil.addClass(button,"mappy-button-active"),button.setAttribute("data-active",1)},deactivateButton:function(button){L.DomUtil.removeClass(button,"mappy-button-active"),button.setAttribute("data-active",0)}});var Geolocation=L.Mappy.Control.extend({options:{geolocationMarker:!1,locateOptions:{}},_defaultLocateOptions:{setView:!0,maxZoom:15,timeout:5e3,maximumAge:3e4},onAdd:function(map){return this.options.locateOptions=L.extend(this._defaultLocateOptions,this.options.locateOptions),this._container=L.DomUtil.create("div","mappy-control-geolocation"),this._geolocButton=this._createButton("<span>?</span>",null,"geolocation",this.activateGeolocation),map.on("locationfound",this.onGeolocationSuccess,this),map.on("locationerror",this.onGeolocationError,this),map.on("moveend zoomend",this.deactivate,this),this._container},activateGeolocation:function(){L.DomUtil.removeClass(this._geolocButton,"geolocation-error"),L.DomUtil.addClass(this._geolocButton,"searching"),this._map.fire("locationsearch"),this._map.locate(this.options.locateOptions)},onRemove:function(map){map.off("locationfound",this.onGeolocationSuccess,this)},onGeolocationSuccess:function(location){if(L.DomUtil.removeClass(this._geolocButton,"searching"),this.activateButton(this._geolocButton),this.options.geolocationMarker)if(this.geolocationMarker)this.geolocationMarker.setLatLng(location.latlng);else{var iconImg="marker_geolocation"+(L.Browser.retina?"_x2":"")+".png",icon=new L.DivIcon({className:"geolocationMarker",iconSize:[30,30],iconAnchor:[15,15],html:'<img src="'+L.Mappy.getImgPath()+iconImg+'" />'});this.geolocationMarker=L.marker(location.latlng,{icon:icon}).addTo(this._map)}},onGeolocationError:function(){L.DomUtil.removeClass(this._geolocButton,"searching"),L.DomUtil.addClass(this._geolocButton,"geolocation-error"),this._map.on("moveend zoomend",L.bind(function(){L.DomUtil.removeClass(this._geolocButton,"geolocation-error")},this))},deactivate:function(){this.deactivateButton(this._geolocButton)}});L.Control.Layers=L.Mappy.Control.extend({options:{autoZIndex:!0,traffic:!0,publicTransport:!0,viewMode:!0,trafficLegend:!0},initialize:function(baseLayers,overlays,options){L.setOptions(this,options),this._buttons={},this.trafficLegend=null,this._layers={},this._lastZIndex=0;for(var i in baseLayers)this._addLayer(baseLayers[i],i);for(i in overlays)this._addLayer(overlays[i],i,!0)},_addLayer:function(layer,name,overlay){var id=L.stamp(layer);this._layers[id]={layer:layer,name:name,overlay:overlay},this.options.autoZIndex&&layer.setZIndex&&(this._lastZIndex++,layer.setZIndex(this._lastZIndex))},onAdd:function(map){return this._container=this._getContainer("layers"),this._initLayout(),this._initActiveButton(),map.on("layeradd",this._onLayerChange,this).on("layerremove",this._onLayerChange,this),this._container},onRemove:function(map){map.off("layeradd",this._onLayerChange,this).off("layerremove",this._onLayerChange,this),this.options.trafficLegend&&this.trafficLegend.hide()},_initLayout:function(){if(this.options.traffic!==!1&&(this._buttons.traffic=this._createSwitch("<span>'</span>",L.Mappy.getText("layers.traffic"),null,"traffic",this.activateTraffic,this.deactivateTraffic)),this.options.publicTransport!==!1&&(this._buttons.publicTransport=this._createSwitch("<span>7</span>",L.Mappy.getText("layers.transport"),null,"transport",this.activatePublicTransport,this.deactivatePublicTransport)),this.options.trafficLegend&&(this.trafficLegend=L.control.TrafficLegend()),this.options.viewMode!==!1){var tooltip=L.DomUtil.create("div"),span=L.DomUtil.create("span",null,tooltip),checkbox=this._createCheckbox(tooltip),label=L.DomUtil.create("label",null,tooltip);this._buttons.hybrid=checkbox,span.innerHTML=L.Mappy.getText("layers.photo"),label.innerHTML=L.Mappy.getText("layers.hybrid"),label.setAttribute("for","mappy-hybrid"),this._buttons.aerial=this._createSwitch("<span>#</span>",tooltip,null,"aerial",function(){this._map.setViewmode("photo")},function(){this._map.setViewmode("standard"),this._map.removeOverlay("hybrid")},500),L.DomEvent.on(tooltip,"mouseenter",this._onAerialTooltipMouseEnter,this).on(tooltip,"mouseleave",this._onAerialTooltipMouseLeave,this).on(checkbox,"click",this._onAerialLabelClick,this)}},_initActiveButton:function(){var overlay=this._map.getTilelayer("overlay");overlay&&this._addOverlay(overlay.options.name),this._updateViewMode(this._map.getTilelayer().options.name)},_onLayerChange:function(e){var obj=this._layers[L.stamp(e.layer)];if(obj){var type=obj.overlay?"layeradd"===e.type?"overlayadd":"overlayremove":"layeradd"===e.type?"baselayerchange":null;obj.overlay?"overlayremove"===type?this._removeOverlay(obj.name):this._addOverlay(obj.name):this._updateViewMode(obj.name),type&&this._map.fire(type,obj)}},_removeOverlay:function(name){"traffic"===name?(this._buttons.traffic&&this.deactivateButton(this._buttons.traffic),this.trafficLegend&&this.trafficLegend.hide()):"public_transport"===name&&this._buttons.publicTransport?this.deactivateButton(this._buttons.publicTransport):"hybrid"===name&&this._buttons.hybrid&&(this._buttons.hybrid.checked=!1)},_addOverlay:function(name){"traffic"===name?(this._buttons.traffic&&this.activateButton(this._buttons.traffic),this.trafficLegend&&this.trafficLegend.show(this._map)):"public_transport"===name&&this._buttons.publicTransport&&this.activateButton(this._buttons.publicTransport),this._buttons.hybrid&&"hybrid"===name&&(this._buttons.hybrid.checked=!0)},_updateViewMode:function(name){this._buttons.aerial&&("standard"===name?this.deactivateButton(this._buttons.aerial):this.activateButton(this._buttons.aerial))},activateTraffic:function(){this._map.setOverlay("traffic"),this.trafficLegend&&this.trafficLegend.show(this._map)},deactivateTraffic:function(){this._map.removeOverlay("traffic"),this.trafficLegend&&this.trafficLegend.hide()},activatePublicTransport:function(){this._map.setOverlay("public_transport")},deactivatePublicTransport:function(){this._map.removeOverlay("public_transport")},_createCheckbox:function(parent){var html='<input type="checkbox" name="mappy-hybrid-checkbox" id="mappy-hybrid" />',htmlFragment=document.createElement("div");return htmlFragment.innerHTML=html,parent.appendChild(htmlFragment.firstChild)},_onAerialTooltipMouseEnter:function(){clearTimeout(this._removing)},_onAerialTooltipMouseLeave:function(){this._closeTooltip("aerial",500)},_onAerialLabelClick:function(){this._buttons.hybrid&&this._buttons.hybrid.checked?("photo"!==this._map.getTilelayer().options.name&&this._map.setViewmode("photo"),this._map.setOverlay("hybrid")):this._map.removeOverlay("hybrid")},getTrafficLegend:function(){return this.trafficLegend}});var Legend=L.Control.extend({options:{position:"bottomright"},initialize:function(options){this.options=L.extend({},this.options,options)},onAdd:function(){this._container=L.DomUtil.create("div","mappy-bike-legend");var left=L.DomUtil.create("div","mappy-bike-legend-col mappy-bike-legend-left",this._container),right=L.DomUtil.create("div","mappy-bike-legend-col mappy-bike-legend-right",this._container),title=(L.DomUtil.create("span","mappy-bike-legend-bicyclepath-box",left),L.DomUtil.create("p","mappy-bike-legend-title",right));return title.innerHTML=L.Mappy.getText("bikelegend.title"),this._container}}),Logo=L.Control.extend({options:{position:"topleft"},onAdd:function(){this._container=L.DomUtil.create("div","mappy-control-logo");var url=L.Mappy.getImgPath()+(L.Browser.retina?"api-logo-2x.png":"api-logo.png");return this._container.style.backgroundImage='url("'+url+'")',this._container},removeFrom:L.Util.falseFn,remove:L.Util.falseFn});L.Mappy.TileLayer=L.TileLayer.extend({options:{minZoom:0,maxZoom:19,tileSize:256,subdomains:"1234"},tileUrl:"http{h}://map{s}.{domain}/map/1.0/slab/{m}/256/{z}/{x}/{y}",descrUrl:"http{h}://map1.{domain}/map/1.0/multi-descr/{m}/256/{z}/{t}",descrInfos:{},attributions:[],layerItems:[],initialize:function(name,zIndex,options){options=L.setOptions(this,L.extend({h:L.Mappy._getHttps()?"s":"",m:name,name:name,zIndex:zIndex,domain:L.Mappy._getDomain()},options)),"photo"!==name&&options.detectRetina&&L.Browser.retina&&(this.options.m+="_hd"),"traffic"===name&&(this.tileUrl+="?refresh={refresh}",options.refresh={toString:function(){return Math.random()}}),L.TileLayer.prototype.initialize.call(this,this.tileUrl,options)},onAdd:function(map){L.TileLayer.prototype.onAdd.call(this,map),this.on("load",this._onLoad),"traffic"===this.options.name&&(this.interval=window.setInterval(L.bind(this.redraw,this),12e4))},onRemove:function(map){L.TileLayer.prototype.onRemove.call(this,map),this.off("load",this._onLoad),"traffic"===this.options.name&&window.clearInterval(this.interval)},getAttributions:function(){return this.attributions},_onLoad:L.Util.debounce(function(){var bounds=this._map.getPixelBounds(),min=bounds.min.clone(),max=bounds.max.clone();min=min.divideBy(this.options.tileSize)._floor(),max=max.divideBy(this.options.tileSize)._floor();for(var tilesCoords=[],x=min.x;x<=max.x;x++)for(var y=min.y;y<=max.y;y++)tilesCoords.push(x+","+y);tilesCoords.length>0&&this._requestDescr(tilesCoords)},500),_refreshAttributions:function(tiles){if(this._map){this.attributions=[],this.layerItems=[];for(var i=0;i<tiles.length;i++){var key=this.options.m+"/"+this._map.getZoom()+"/"+tiles[i].replace(",","/");if(this.descrInfos[key]){for(var j=0;j<this.descrInfos[key].copyrights.length;j++)this.attributions.push(this.descrInfos[key].copyrights[j].name);this.layerItems=this.layerItems.concat(this.descrInfos[key].items)}}this.fire("attributionsrefresh")}},_requestDescr:function(tiles){for(var zoomLevel=this._map.getZoom(),reqTiles=[],i=0;i<tiles.length;i++){var key=this.options.m+"/"+zoomLevel+"/"+tiles[i].replace(",","/");this.descrInfos[key]||reqTiles.push(tiles[i])}if(reqTiles.length>0){var requestUrl=L.Util.template(this.descrUrl,L.extend({z:zoomLevel,t:reqTiles.join(";")},this.options));L.Mappy.cors({url:requestUrl,success:L.bind(function(response){for(var i=0;i<response.length;i++)this.descrInfos[this.options.m+"/"+response[i].sid]=response[i];this._refreshAttributions(tiles)},this)})}else this._refreshAttributions(tiles)}});var Tooltip=L.Class.extend({options:{width:"auto",minWidth:"",maxWidth:"",showDelay:500,hideDelay:500,mouseOffset:L.point(0,20),fadeAnimation:!0,trackMouse:!1},initialize:function(options){L.setOptions(this,options),this._createTip()},_createTip:function(){if(this._map=this.options.map,!this._map)throw new Error("No map configured for tooltip");this._container=L.DomUtil.create("div","leaflet-tooltip"),L.DomUtil.addClass(this._container,"mappy-tooltip-transport"),this._container.style.position="absolute",this._container.style.width=this._isNumeric(this.options.width)?this.options.width+"px":this.options.width,this._container.style.minWidth=this._isNumeric(this.options.minWidth)?this.options.minWidth+"px":this.options.minWidth,this._container.style.maxWidth=this._isNumeric(this.options.maxWidth)?this.options.maxWidth+"px":this.options.maxWidth,this.options.html&&this.setHtml(this.options.html),this.options.target&&this.setTarget(this.options.target),this._map._tooltipContainer.appendChild(this._container)},isVisible:function(){return this._showing},setTarget:function(target){target._icon&&(target=target._icon),target!==this._target&&(this._target&&this._unbindTarget(this._target),this._bindTarget(target),this._target=target)},_bindTarget:function(target){L.DomEvent.on(target,"mouseover",this._onTargetMouseover,this).on(target,"mouseout",this._onTargetMouseout,this).on(target,"mousemove",this._onTargetMousemove,this)},_unbindTarget:function(target){L.DomEvent.off(target,"mouseover",this._onTargetMouseover,this).off(target,"mouseout",this._onTargetMouseout,this).off(target,"mousemove",this._onTargetMousemove,this)},setHtml:function(html){if("string"==typeof html)this._container.innerHTML=html;else{for(;this._container.hasChildNodes();)this._container.removeChild(this._container.firstChild);this._container.appendChild(this._content)}this._sizeChanged=!0},setPosition:function(point){var mapSize=this._map.getSize(),container=this._container,containerSize=this._getElementSize(this._container);point=point.add(this.options.mouseOffset),point.x+containerSize.x>mapSize.x?(container.style.left="auto",container.style.right=mapSize.x-point.x+"px"):(container.style.left=point.x+"px",container.style.right="auto"),point.y+containerSize.y>mapSize.y?(container.style.top="auto",container.style.bottom=mapSize.y-point.y+2*this.options.mouseOffset.y+"px"):(container.style.top=point.y+"px",container.style.bottom="auto")},remove:function(){this._container.parentNode.removeChild(this._container),delete this._container,this._target&&this._unbindTarget(this._target)},show:function(point,html){Tooltip.activeTip&&Tooltip.activeTip!=this&&Tooltip.activeTip._hide(),Tooltip.activeTip=this,html&&this.setHtml(html),this.setPosition(point),this.options.showDelay?this._delay(this._show,this,this.options.hideDelay):this._show()},_show:function(){this._container.style.display="inline-block",L.DomUtil.addClass(this._container,"leaflet-tooltip-fade"),this._showing=!0},hide:function(){this.options.hideDelay?this._delay(this._hide,this,this.options.hideDelay):this._hide()},_hide:function(){this._timeout&&clearTimeout(this._timeout),L.DomUtil.removeClass(this._container,"leaflet-tooltip-fade"),this._container.style.display="none",this._showing=!1,Tooltip.activeTip===this&&delete Tooltip.activeTip},_delay:function(func,scope,delay){var me=this;this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout(function(){func.call(scope),delete me._timeout},delay)},_isNumeric:function(val){return!isNaN(parseFloat(val))&&isFinite(val)},_getElementSize:function(el){var size=this._size;return(!size||this._sizeChanged)&&(size={},el.style.left="-999999px",el.style.right="auto",el.style.display="inline-block",size.x=el.offsetWidth,size.y=el.offsetHeight,el.style.left="auto",el.style.display="none",this._sizeChanged=!1),size},_onTargetMouseover:function(e){var point=this._map.mouseEventToContainerPoint(e);this.show(point)},_onTargetMousemove:function(e){if(L.DomEvent.stopPropagation(e),this.options.trackMouse){var point=this._map.mouseEventToContainerPoint(e);this.setPosition(point)}},_onTargetMouseout:function(){this.hide()}});L.Map.addInitHook(function(){this._tooltipContainer=L.DomUtil.create("div","leaflet-tooltip-container",this._container)}),function(){var originalOnAdd=L.Marker.prototype.onAdd,originalOnRemove=L.Marker.prototype.onRemove,originalSetIcon=L.Marker.prototype.setIcon;L.Marker.include({getTooltip:function(){return this._tooltip},onAdd:function(map){originalOnAdd.call(this,map),this.options.tooltip&&(this._tooltip=new Tooltip(L.extend(this.options.tooltip,{target:this,map:map})))},onRemove:function(map){this._tooltip&&this._tooltip.remove(),originalOnRemove.call(this,map)},setIcon:function(icon){originalSetIcon.call(this,icon),this._tooltip&&this._tooltip.setTarget(this._icon)}})}(),L.Control.TrafficLegend=L.Mappy.Control.extend({options:{position:"bottomright"},_initLayout:function(){this._container=L.DomUtil.create("div","mappy-traffic-legend clearfix");var table=(L.DomUtil.create("p","mappy-traffic-legend-title",this._container),L.DomUtil.create("table","",this._container)),tr=L.DomUtil.create("tr","",table);L.DomUtil.create("td","orange",tr),L.DomUtil.create("td","red",tr),L.DomUtil.create("td","darkred",tr),L.DomUtil.create("td","black",tr);var leftText=L.DomUtil.create("p","left",this._container);leftText.innerHTML=L.Mappy.getText("trafficLegend.slow");var rightText=L.DomUtil.create("p","right",this._container);return rightText.innerHTML=L.Mappy.getText("trafficLegend.blocked"),this._container},show:function(map){return this._map?(this.refresh(),this._container&&L.DomUtil.addClass(this._container.parentElement,"leaflet-control-with-traffic"),void 0):(this.addTo(map),this._container&&L.DomUtil.addClass(this._container.parentElement,"leaflet-control-with-traffic"),void 0)},hide:function(){this._container&&L.DomUtil.removeClass(this._container.parentElement,"leaflet-control-with-traffic"),this._map&&(this.removeFrom(this._map),this._map=null)},onAdd:function(){return this._container||this._initLayout(),this.refresh(),this.interval=window.setInterval(L.bind(this.refresh,this),12e4),this._container},onRemove:function(){window.clearInterval(this.interval)},refresh:function(){var now=new Date;this._container.querySelector("p.mappy-traffic-legend-title").innerHTML=L.Util.template(L.Mappy.getText("trafficLegend.trafficAt"),{hours:now.getHours(),minutes:(now.getMinutes()<10?"0":"")+now.getMinutes()})}}),L.control.TrafficLegend=function(options){return new L.Control.TrafficLegend(options)},L.Control.Zoom=L.Mappy.Control.extend({options:{zoomSlider:!1},onAdd:function(){return this._container=this._getContainer("zoom"),this._initLayout(),this._container},onRemove:function(map){map.off("zoomlevelschange",this._updateSize,this).off("zoomend zoomlevelschange",this._updateKnobValue,this)},_initLayout:function(){var additionalClass=this.options.zoomSlider?" mappy-button-zoom-full":"";this._buttons.zoomIn=this._createButton("<span>+</span>",null,"zoom-in"+additionalClass,function(e){this._map.zoomIn(e.shiftKey?3:1)}),this.options.zoomSlider&&(this._buttons.slider=this._createSlider(),this._buttons.knob=new Knob(this._buttons.slider.knob,8,8),this._map.whenReady(this._initKnob,this).whenReady(this._initEvents,this).whenReady(this._updateSize,this).whenReady(this._updateKnobValue,this)),this._buttons.zoomOut=this._createButton("<span>-</span>",null,"zoom-out"+additionalClass,function(e){this._map.zoomOut(e.shiftKey?3:1)})},_createSlider:function(){var ui={};return ui.bar=L.DomUtil.create("div","mappy-slider",this._container),ui.wrap=L.DomUtil.create("div","mappy-slider-wrap",ui.bar),ui.body=L.DomUtil.create("div","mappy-slider-body",ui.wrap),ui.knob=L.DomUtil.create("div","mappy-slider-knob"),L.DomEvent.disableClickPropagation(ui.bar),L.DomEvent.disableClickPropagation(ui.knob),ui},_initKnob:function(){this._buttons.knob.enable(),this._buttons.slider.body.appendChild(this._buttons.slider.knob)},_initEvents:function(){this._map.on("zoomlevelschange",this._updateSize,this).on("zoomend zoomlevelschange",this._updateKnobValue,this),L.DomEvent.on(this._buttons.slider.body,"click",this._onSliderClick,this),this._buttons.knob.on("dragend",this._updateMapZoom,this)},_onSliderClick:function(e){var first=e.touches&&1===e.touches.length?e.touches[0]:e,y=L.DomEvent.getMousePosition(first,this._buttons.slider.body).y;this._buttons.knob.setPosition(y),this._updateMapZoom()},_zoomLevels:function(){var zoomLevels=this._map.getMaxZoom()-this._map.getMinZoom()+1;return 1/0>zoomLevels?zoomLevels:0},_toZoomLevel:function(value){return value+this._map.getMinZoom()},_toValue:function(zoomLevel){return zoomLevel-this._map.getMinZoom()},_updateSize:function(){var steps=this._zoomLevels();this._buttons.slider.body.style.height=8*steps+"px",this._buttons.knob.setSteps(steps)},_updateMapZoom:function(){this._map.setZoom(this._toZoomLevel(this._buttons.knob.getValue()))},_updateKnobValue:function(){this._buttons.knob.setValue(this._toValue(this._map.getZoom()))}});var Knob=L.Draggable.extend({initialize:function(element,stepHeight,knobHeight){L.Draggable.prototype.initialize.call(this,element,element),this._element=element,this._stepHeight=stepHeight,this._knobHeight=knobHeight,this.on("predrag",function(){this._newPos.x=0,this._newPos.y=this._adjust(this._newPos.y)},this)},_adjust:function(y){var value=Math.round(this._toValue(y));return value=Math.max(0,Math.min(this._maxValue,value)),this._toY(value)},_toY:function(value){return this._k*value+this._m},_toValue:function(y){return(y-this._m)/this._k},setSteps:function(steps){var sliderHeight=steps*this._stepHeight;this._maxValue=steps-1,this._k=-this._stepHeight,this._m=sliderHeight-(this._stepHeight+this._knobHeight)/2
},setPosition:function(y){L.DomUtil.setPosition(this._element,L.point(0,this._adjust(y)))},setValue:function(v){this.setPosition(this._toY(v))},getValue:function(){return this._toValue(L.DomUtil.getPosition(this._element).y)}});L.Mappy.Map=L.Map.extend({_tileLayers:{},_tooltip:null,disabledActions:[],initialize:function(element,options){options=options||{},options.clientId&&L.Mappy.setClientId(options.clientId),L.Mappy._checkClientId();var zoomControlOptions=void 0!==options.zoomControl?options.zoomControl:!0;options.zoomControl=!1;var attributionControlOptions=void 0!==options.attributionControl?options.attributionControl:{};options.attributionControl=!1,options.maxBounds=options.maxBounds||L.latLngBounds(L.latLng(-90,-1e5),L.latLng(90,1e5)),options.worldCopyJump=void 0!==options.worldCopyJump?options.worldCopyJump:!0,options.zoomAnimationThreshold=void 0!==options.zoomAnimationThreshold?options.zoomAnimationThreshold:3,this.baseLayers={standard:new L.Mappy.TileLayer("standard",1,options.tileLayerOptions),photo:new L.Mappy.TileLayer("photo",1,options.tileLayerOptions)};var publicTransportLayerOptions={minZoom:options.tileLayerOptions&&options.tileLayerOptions.minZoom>6?options.tileLayerOptions.minZoom:6};this.overlays={public_transport:new L.Mappy.TileLayer("public_transport",2,L.extend({},options.tileLayerOptions,publicTransportLayerOptions)),traffic:new L.Mappy.TileLayer("traffic",2,options.tileLayerOptions),hybrid:new L.Mappy.TileLayer("hybrid",2,options.tileLayerOptions)},L.Map.prototype.initialize.call(this,element,options),this.attributionControl=new Attribution(attributionControlOptions).addTo(this),options.logoControl!==!1&&(this.logoControl=new Logo(options.logoControl||{}).addTo(this)),options.viewmode&&this.baseLayers[options.viewmode]?this.addLayer(this.baseLayers[options.viewmode]):this.addLayer(this.baseLayers.standard),zoomControlOptions!==!1&&(this.zoomControl=L.control.zoom(zoomControlOptions||{}).addTo(this)),(void 0===options.layersControl||options.layersControl)&&(this.layersControl=L.control.layers(this.baseLayers,this.overlays,options.layersControl||{}).addTo(this)),options.geolocationControl&&"geolocation"in navigator&&(this.geolocationControl=new Geolocation(options.geolocationControl).addTo(this)),options.legendControl&&(this.legendControl=new Legend(options.legendControl).addTo(this)),options.tooltip!==!1&&this.manageTooltip()},manageTooltip:function(){this._tooltip=new Tooltip({map:this,showDelay:0,hideDelay:0}),this.on("mousemove",this._handleMousemove),this.on("move",this._tooltip.hide,this._tooltip),this.on("zoomstart",this._tooltip.hide,this._tooltip),L.Browser.touch||L.DomUtil.addClass(this._container,"no-touch")},setViewmode:function(name){name=name||"standard",this._setTileLayer(this.baseLayers,name),this.baseLayers[name]&&this.fire("viewmode-"+name,this.baseLayers[name])},setOverlay:function(name){this._setTileLayer(this.overlays,name),this.fire("overlay-"+(name?name:"disabled"),this.overlays[name]?this.overlays[name]:null)},removeOverlay:function(name){this.removeLayer(this.overlays[name]),this.fire("overlay-disabled",this.overlays[name]?this.overlays[name]:null)},disableInteractions:function(){var actions=["dragging","touchZoom","scrollWheelZoom","doubleClickZoom","boxZoom","keyboard"];this.disabledActions=[];for(var i=0;i<actions.length;i++)this[actions[i]]&&this[actions[i]].enabled()&&(this.disabledActions.push(actions[i]),this[actions[i]].disable())},enableInteractions:function(){for(var i=0;i<this.disabledActions.length;i++)this[this.disabledActions[i]].enable()},getTilelayer:function(type){var layers="overlay"===type?this.overlays:this.baseLayers;for(var layerName in layers)if(this.hasLayer(layers[layerName]))return layers[layerName];return null},_setTileLayer:function(layers,name){if("hybrid"===name)this.addLayer(layers[name]);else{for(var layerName in layers)!this.hasLayer(layers[layerName])||"hybrid"===layerName&&name||this.removeLayer(layers[layerName]);layers[name]&&this.addLayer(layers[name])}return this},_handleMousemove:function(event){var items=this.getTilelayer();if(items){items=items.layerItems;var overlay=this.getTilelayer("overlay");overlay&&(items=items.concat(overlay.layerItems));for(var i=0,found=!1;i<items.length&&!found;){var box=items[i].box;box.minx<event.latlng.lng&&event.latlng.lng<box.maxx&&box.miny<event.latlng.lat&&event.latlng.lat<box.maxy&&(this._tooltip.isVisible()||this._showItemTooltip(items[i]),found=!0),i++}found||this._tooltip.hide()}},_showItemTooltip:function(item){var baseUrl="http"+(L.Mappy._getHttps()?"s":"")+"://logotc."+L.Mappy._getDomain()+"/pictos/web/desktop/",transportLabels={M:"metro",S:"rer",T:"train",TY:"tram"},lines=[],itemLine=item.properties.description.line;itemLine=itemLine instanceof Array?itemLine:[itemLine];for(var j=0;j<itemLine.length;j++)lines[itemLine[j].type]||(lines[itemLine[j].type]=[]),lines[itemLine[j].type].push(itemLine[j].num);var description="";for(var type in lines)if(lines.hasOwnProperty(type)){var lineType=transportLabels[type]||type,icons=['<img src="'+baseUrl+"modes/"+lineType+'.png" />'];for(var line in lines[type])if(lines[type].hasOwnProperty(line)){var lineName="tram"===lineType?"t"+lines[type][line].toLowerCase():lines[type][line].toLowerCase();icons.push('<img src="'+baseUrl+"lines/stif_"+lineType+"_"+lineName+'.png" />')}description+="</p><p>"+icons.join("")}var popupPosition=this.latLngToContainerPoint(L.latLng((item.box.maxy+item.box.miny)/2,(item.box.maxx+item.box.minx)/2));this._tooltip.show(popupPosition,"<div><p><span>"+item.properties.description.label+"</span>"+description+"</p></div>")},addLegendControl:function(options){options=options||this.options.legendControl||{},this.legendControl||(this.legendControl=new Legend(options.legendControl).addTo(this))},removeLegendControl:function(){this.legendControl&&(this.legendControl.remove(),this.legendControl=null)}}),L.Handler.MarkerDrag.prototype._onDrag=function(){var marker=this._marker,shadow=marker._shadow,iconPos=L.DomUtil.getPosition(marker._icon),topLeft=marker._map.containerPointToLayerPoint([0,0]),bottomRight=marker._map.containerPointToLayerPoint(marker._map.getSize()),newPos=new L.Point(Math.max(topLeft.x+5,Math.min(iconPos.x,bottomRight.x-5)),Math.min(bottomRight.y-5,Math.max(iconPos.y,topLeft.y+15)));L.DomUtil.setPosition(marker._icon,newPos);var latlng=marker._map.layerPointToLatLng(newPos);shadow&&L.DomUtil.setPosition(shadow,newPos),marker._latlng=latlng,marker.fire("move",{latlng:latlng}).fire("drag")},L.Mappy.Route=L.FeatureGroup.extend({initialize:function(routes,routeId,alternative){L.FeatureGroup.prototype.initialize.call(this),this.polylineStepIdx=[],this._markers=[];for(var actions=routes.route[routeId||0].actions.action,i=0;i<actions.length;i++)"waypoint"===actions[i].type&&(this._createStepMarker(L.latLng(actions[i].y,actions[i].x),"step"),this.polylineStepIdx.push(parseInt(actions[i]["polyline-index"],10)));this.colorDictionary=routes["color-dictionary"].color,this.colorDictionary.length||(this.colorDictionary=[this.colorDictionary]),this.alternative=!!alternative,this.route=routes.route[routeId||0]["polyline-definition"],this.points=L.polyline(this.route.polyline).getLatLngs(),this._createShapes(),this._createStepMarker(this.points[0],"start"),this._createStepMarker(this.points[this.points.length-1],"end")},getMarkers:function(){return this._markers},_createShapes:function(){var roadSection,bikeFacility,roadSections=this.route["road-section-collection"]["road-sections"];if(L.polyline(this.points,{color:"#FFF",weight:9,opacity:.58}).addTo(this),roadSections instanceof Array)for(var i=0;i<roadSections.length;i++)"bike-facility"===roadSections[i].type?bikeFacility=roadSections[i]["road-section"].split(" "):roadSection=roadSections[i]["road-section"].split(" ");else roadSection=roadSections["road-section"].split(" ");for(var sections=this._parseSection(roadSection),j=0;j<sections.length;j++){L.polyline(sections[j].polyline,{color:sections[j].color,opacity:.58,weight:5}).addTo(this);for(var found=!1,k=0;k<this.polylineStepIdx.length;k++)this.polylineStepIdx[k]===sections[j].sliceEnd&&(found=!0);sections[j].sliceEnd<this.points.length-1&&!found&&L.marker(this.points[sections[j].sliceEnd],{icon:new L.DivIcon({className:"mappy-connexion-marker",iconSize:[10,10],iconAnchor:[5,5]})}).addTo(this)}this._applyBikeFacility(bikeFacility)},_parseSection:function(section){for(var sliceEnd,color,type,colorValue,sections=[],sliceStart=0,i=0;i<section.length;i+=2){sliceEnd=parseInt(section[i+1],10),color="";for(var colorIdx in this.colorDictionary)this.colorDictionary[colorIdx].value!==section[i]||!this.alternative&&-1!==this.colorDictionary[colorIdx].type.indexOf("-alt")||(color=this.colorDictionary[colorIdx].color,type=this.colorDictionary[colorIdx].type,colorValue=this.colorDictionary[colorIdx].value);var sectionPolyline=this.points.slice(sliceStart,sliceEnd+1);sliceStart=sliceEnd,sections.push({polyline:sectionPolyline,color:color,type:type,sliceEnd:sliceEnd,colorValue:colorValue})}return sections},_applyBikeFacility:function(bikeFacility){if(bikeFacility)for(var sections=this._parseSection(bikeFacility),i=0;i<sections.length;i++)"bike-facility"===sections[i].type&&"0"!==sections[i].colorValue&&L.polyline(sections[i].polyline,{color:sections[i].color,weight:7,opacity:1}).addTo(this)},_createStepMarker:function(latLng,type){var src=L.Mappy.getImgPath()+"roadbook-step-"+type+".png",marker=L.marker(latLng,{icon:new L.DivIcon({className:"iti-marker mappy-route-"+type,html:'<img src="'+src+'" />',iconSize:[40,50],iconAnchor:[20,50]})});marker.addTo(this),this._markers.push({type:type,marker:marker,latLng:latLng})}}),L.Mappy.route=function(routes,routeId,alternative){return new L.Mappy.Route(routes,routeId,alternative)},L.Mappy.Vehicles=["comcar","midcar","sedcar","luxcar","caravancar","2-lt3.5","2-lt12","2-gt12","2-gt12a","3-lt3.5","3-lt12","3-gt12","3-gt12a","mot","van","2-coa","3-coa","ped","bik","bike","pub_tp"];var routeErrors=["nostart","noend","nostartprovider","noendprovider","nostarttoendprovider","nonetworkconnexion"];L.Mappy.Services={localeParameters:{fr_FR:{favoriteCountry:250,language:"fre"},en_GB:{favoriteCountry:826,language:"eng"},fr_BE:{favoriteCountry:56,language:"fre"},nl_BE:{favoriteCountry:56,language:"dut"}},_decodePolyline:function(encoded){for(var len=encoded.length,tmp=[],decoded=[],index=0,lat=0,lng=0,decodeNextPoint=function(){var b,shift=0,result=0;do b=encoded.charCodeAt(index++)-63,result|=(31&b)<<shift,shift+=5;while(b>=32);return(1&result)>0?~(result>>1):result>>1};len>index;)tmp.push(decodeNextPoint());for(var i=0;i<tmp.length;i+=2)lat+=1e-5*tmp[i],lng+=1e-5*tmp[i+1],decoded.push([lat,lng]);return decoded},geocode:function(query,successCallback,failureCallback){L.Mappy._checkClientId(),query instanceof L.LatLng?query=query.lat+","+query.lng:query instanceof Array&&(query=query[0]+","+query[1]),L.Mappy.JSONP({url:"http"+(L.Mappy._getHttps()?"s":"")+"://axe."+L.Mappy._getDomain()+"/1v1/loc/get.aspx",data:{"opt.format":"json","opt.namedPlaceSearch":1,"opt.interactive":1,"opt.language":this.localeParameters[L.Mappy.getLocale()].language,"opt.favoriteCountry":this.localeParameters[L.Mappy.getLocale()].favoriteCountry,"opt.xmlOutput":"3v0",auth:L.Mappy._getToken(),fullAddress:query},success:function(response){if(!response.kml.Document)return failureCallback("no_result");var placemark=response.kml.Document.Placemark;return placemark=placemark instanceof Array?placemark:[placemark],0===placemark.length?failureCallback("no_result"):(successCallback(placemark),void 0)},error:failureCallback})},route:function(steps){L.Mappy._checkClientId();var successCallback,failureCallback,options={};if("function"==typeof arguments[1])successCallback=arguments[1],failureCallback=arguments[2];else{for(var name in arguments[1])options[name]=arguments[1][name];successCallback=arguments[2],failureCallback=arguments[3]}this._requestRoute(steps,options,successCallback,failureCallback)},_requestRoute:function(steps,options,successCallback,failureCallback){var step,elt,data=L.extend(options||{},{clientid:L.Mappy._getClientId(),wt:"json",from:"",to:"",vehicle:options.vehicle||"comcar"}),requestPath="pub_tp"===options.vehicle||"bike"===options.vehicle?"route":"route_vehicle";data=this._getNormalizedVehicleOptions(data,"route"===requestPath);for(var i=0;i<steps.length;i++)step=L.latLng(steps[i]),0===i?elt="from":i===steps.length-1?elt="to":(elt="stops",data.stops=data.stops||""),data[elt]+=("stops"===elt&&i>1?";":"")+step.lng+","+step.lat;this._request("cors","http"+(L.Mappy._getHttps()?"s":"")+"://routemm."+L.Mappy._getDomain()+"/"+requestPath+"/roadbook",data,successCallback,failureCallback)},_request:function(type,url,data,successCallback,failureCallback){L.Mappy[type]({url:url,data:data,success:L.bind(function(results){if(results.routes.route.length||(results.routes.route=[results.routes.route]),0===results.routes.route.length)return failureCallback("no_result");if(!results.routes.route[0].actions){var error=routeErrors.indexOf(results.routes.route[0].stats.error)>-1?results.routes.route[0].stats.error:"no_result";return failureCallback(error)}for(var i=0;i<results.routes.route.length;i++){var polyline=this._decodePolyline(results.routes.route[i]["polyline-definition"].polyline);results.routes.route[i]["polyline-definition"].polyline=polyline}successCallback(results)},this),error:failureCallback})},_getNormalizedVehicleOptions:function(data,isRouteService){var routeParams,params={};routeParams={from:"from",to:"to",stops:"stops",clientid:"clientid",infotraffic:"rb.infotraffic",date:"rt.date",time:"rt.time",sens:"rt.sens",notoll:"rt.notoll",cost:"rt.cost",lang:"rb.lang",axl:"rb.axl",gas:"rb.gas",nbroutes:"rt.nbroutes",cvn:"rb.cvn",wt:"wt",vehicle:"rb.veh",criteria:"criteria"},isRouteService&&(routeParams={from:"from",to:"to",stops:"stops",clientid:"clientid",date:"date",time:"time",sens:"sens",nbroutes:"nbroutes",wt:"wt",vehicle:"transport_mode",criteria:"criteria"});for(var name in data)routeParams[name]&&(params[routeParams[name]]=data[name]);return/^2-/.test(data.vehicle)&&(params["rb.veh"]=data.vehicle.replace(/^(2-)/,""),params["rb.axl"]="2ax"),/^3-/.test(data.vehicle)&&(params["rb.veh"]=data.vehicle.replace(/^(3-)/,""),params["rb.axl"]="3ax"),"caravancar"===data.vehicle&&(params["rb.veh"]="midcar",params["rb.cvn"]="1"),params}}}(window.L);